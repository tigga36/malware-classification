#URLのアクセス先からファイルダウンロード及びファイルからstrings抽出用(exe, zip, rar, xpi)

import chromedriver_binary
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.action_chains import ActionChains
from selenium.webdriver.common.keys import Keys
import time
import traceback
import custom_expected_conditions
import glob
import strings
import json
import os
import re
import zipfile
import rarfile
import shutil

options = webdriver.ChromeOptions()
options.add_argument('--headless')
options.add_argument('--disable-gpu')
options.add_experimental_option("prefs", {
  "download.default_directory": r"/home/atsuko/NLP/Cnet",
  "download.prompt_for_download": False,
  "download.directory_upgrade": True,
  "safebrowsing.enabled": True
})

driver = webdriver.Chrome(options=options)

path1 = 'url.txt'
with open(path1, 'r', encoding='utf-8') as f1:
    urls = f1.readlines()

path2 = 'extracted.txt'
with open(path2, 'r', encoding='utf-8') as f2:
    exd = f2.readlines()

path3 = 'not.txt'
with open(path3, 'r', encoding='utf-8') as f3:
    no = f3.readlines()

path4 = 'icci.txt'
with open(path4, 'r', encoding='utf-8') as f4:
    icci = f4.readlines()


exe_n = len(exd)
count = len(icci) + 1
try:
    n1 = 0
    for url in urls[exe_n:]:
        driver.get(url.strip())
        try:
            download = driver.find_element(By.XPATH, '//*[@id="product-upper-container"]/div[2]/div[1]/div/a')
            if download.text == 'DOWNLOAD NOW':
                try:
                    href = download.get_attribute("href")
                    driver.get(href)
                    time.sleep(5)
                    files = glob.glob("Cnet/*")
                    n2 = len(files)
                    if not(n1 < n2):
                        try:
                            driver.find_element(By.XPATH, '//*[@id="pdl-manual"]').click()
                        except:
                            import traceback
                            traceback.print_exc()
                    WebDriverWait(driver, 20).until(
                        custom_expected_conditions.file_existed()
                    )
                    time.sleep(3)
                except:
                    import traceback
                    traceback.print_exc()
            else:
                no.append(url)
        except:
            import traceback
            traceback.print_exc()
            no.append(url)
        exd.append(url)
        strings_files = glob.glob("Cnet_strings/*")
        files = glob.glob("Cnet/*")
        files = [file_path for file_path in files if not(re.search(r'(^Cnet/未確認)|(\.crdownload$)', file_path))]
        for file_path in files:
            try:
                if re.search(r'(\.exe$)|(\.EXE$)', file_path):
                    str_list = strings.run(file_path)
                    dic = {
                        "strings": str_list
                    }
                    if 'Cnet_strings/' + file_path[5:] + '.json' in strings_files:
                        path = 'Cnet_strings/' + file_path[5:] + str(count) + '.json'
                        count += 1
                        icci.append(path + '\n')
                    else:
                        path = 'Cnet_strings/' + file_path[5:] + '.json'
                    with open(path, 'w', encoding='utf-8') as f:
                        json.dump(dic, f, indent=4, ensure_ascii=False)
                    os.remove(file_path)
                elif re.search(r'\.zip$', file_path):
                    with zipfile.ZipFile(file_path) as existing_zip:
                        name_list = existing_zip.namelist()
                        name_list = [name for name in name_list if re.search(r'(\.exe$)|(\.EXE$)', name)]
                        for name in name_list:
                            existing_zip.extract(name, 'Cnet')
                            str_list = strings.run('Cnet/' + name)
                            dic = {
                                "strings": str_list
                            }
                            os.remove('Cnet/' + name)
                            dirs = os.listdir('Cnet/')
                            dirs = [dir_name for dir_name in dirs if os.path.isdir(os.path.join('Cnet/', dir_name))]
                            for d in dirs:
                                shutil.rmtree('Cnet/' + d)
                            name = name.replace('/', '_')
                            if 'Cnet_strings/' + file_path[5:] + '_' + name + '.json' in strings_files:
                                path = 'Cnet_strings/' + file_path[5:] + '_' + name + str(count) + '.json'
                                count += 1
                                icci.append(path + '\n')
                            else:
                                path = 'Cnet_strings/' + file_path[5:] + '_' + name + '.json'
                            with open(path, 'w', encoding='utf-8') as f:
                                json.dump(dic, f, indent=4, ensure_ascii=False)
                    os.remove(file_path)
                elif re.search(r'\.rar$', file_path):
                    with rarfile.RarFile(file_path) as existing_rar:
                        name_list = existing_rar.namelist()
                        name_list = [name for name in name_list if re.search(r'(\.exe$)|(\.EXE$)', name)]
                        for name in name_list:
                            existing_rar.extract(name, 'Cnet')
                            str_list = strings.run('Cnet/' + name)
                            dic = {
                                "strings": str_list
                            }
                            os.remove('Cnet/' + name)
                            dirs = os.listdir('Cnet/')
                            dirs = [dir_name for dir_name in dirs if os.path.isdir(os.path.join('Cnet/', dir_name))]
                            for d in dirs:
                                shutil.rmtree('Cnet/' + d)
                            name = name.replace('/', '_')
                            if 'Cnet_strings/' + file_path[5:] + '_' + name + '.json' in strings_files:
                                path = 'Cnet_strings/' + file_path[5:] + '_' + name + str(count) + '.json'
                                count += 1
                                icci.append(path + '\n')
                            else:
                                path = 'Cnet_strings/' + file_path[5:] + '_' + name + '.json'
                            with open(path, 'w', encoding='utf-8') as f:
                                json.dump(dic, f, indent=4, ensure_ascii=False)
                    os.remove(file_path)
                elif re.search(r'\.xpi$', file_path):
                    after_path = file_path[:-4] + '.zip'
                    os.rename(file_path, after_path)
                    with zipfile.ZipFile(after_path) as existing_zip:
                        name_list = existing_zip.namelist()
                        name_list = [name for name in name_list if re.search(r'(\.exe$)|(\.EXE$)', name)]
                        for name in name_list:
                            existing_zip.extract(name, 'Cnet')
                            str_list = strings.run('Cnet/' + name)
                            dic = {
                                "strings": str_list
                            }
                            os.remove('Cnet/' + name)
                            dirs = os.listdir('Cnet/')
                            dirs = [dir_name for dir_name in dirs if os.path.isdir(os.path.join('Cnet/', dir_name))]
                            for d in dirs:
                                shutil.rmtree('Cnet/' + d)
                            name = name.replace('/', '_')
                            if 'Cnet_strings/' + file_path[5:] + '_' + name + '.json' in strings_files:
                                path = 'Cnet_strings/' + file_path[5:] + '_' + name + str(count) + '.json'
                                count += 1
                                icci.append(path + '\n')
                            else:
                                path = 'Cnet_strings/' + file_path[5:] + '_' + name + '.json'
                            with open(path, 'w', encoding='utf-8') as f:
                                json.dump(dic, f, indent=4, ensure_ascii=False)
                    os.remove(after_path)
                else:
                    shutil.move(file_path, 'else/' + file_path[5:])
            except:
                import traceback
                traceback.print_exc()
                shutil.move(file_path, 'else/' + file_path[5:])

        files = glob.glob("Cnet/*")
        n1 =  len(files)

except:
    import traceback
    traceback.print_exc()

with open(path2, 'w', encoding='utf-8') as f2:
    f2.writelines(exd)
with open(path3, 'w', encoding='utf-8') as f3:
    f3.writelines(no)
with open(path4, 'w', encoding='utf-8') as f4:
    f4.writelines(icci)

while True:
    flag = True
    files = glob.glob("Cnet/*")
    for file_path in files:
        if '.exe.crdownload' in file_path:
            flag = False
    if flag:
        break
    time.sleep(5)
driver.quit()