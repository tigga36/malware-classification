#ファイルからstrings抽出用(tar)

import tarfile
import glob
import re
import json
import os
import shutil
import strings

files = glob.glob("Cnet/*")
files = [file_path for file_path in files if re.search(r'(\.tar\.gz$)|(\.tar\.xz$)', file_path)]
strings_files = glob.glob("Cnet_strings/*")

path4 = 'icci.txt'
with open(path4, 'r', encoding='utf-8') as f4:
    icci = f4.readlines()
count = len(icci) + 1
for file_path in files:
    try:
        with tarfile.open(file_path) as existing_tar:
            name_list = existing_tar.getnames()
            #print(name_list)
            name_list = [name for name in name_list if re.search(r'(\.exe$)|(\.EXE$)', name)]
            for name in name_list:
                existing_tar.extract(member=name, path='Cnet')
                str_list = strings.run('Cnet/' + name)
                dic = {
                    "strings": str_list
                }
                os.remove('Cnet/' + name)
                dirs = os.listdir('Cnet/')
                dirs = [dir_name for dir_name in dirs if os.path.isdir(os.path.join('Cnet/', dir_name))]
                for d in dirs:
                    shutil.rmtree('Cnet/' + d)
                name = name.replace('/', '_')
                if 'Cnet_strings/' + name + '.json' in strings_files:
                    path = 'Cnet_strings/' + name + str(count) + '.json'
                    count += 1
                    icci.append(path + '\n')
                else:
                    path = 'Cnet_strings/' + name + '.json'
                with open(path, 'w', encoding='utf-8') as f:
                    json.dump(dic, f, indent=4, ensure_ascii=False)
        os.remove(file_path)
    except:
        import traceback
        traceback.print_exc()
        shutil.move(file_path, 'else/' + file_path[5:])
with open(path4, 'w', encoding='utf-8') as f4:
    f4.writelines(icci)