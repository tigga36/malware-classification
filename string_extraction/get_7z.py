#ファイルからstrings抽出(7z)

import glob
import re
import json
import os
import shutil
import strings
import subprocess

files = glob.glob("Cnet/*")
files = [file_path for file_path in files if re.search(r'\.7z$', file_path)]
strings_files = glob.glob("Cnet_strings/*")

path4 = 'icci.txt'
with open(path4, 'r', encoding='utf-8') as f4:
    icci = f4.readlines()
count = len(icci) + 1
for file_path in files:
    try:
        command = '7z x -o"' + file_path[:-3] + '" "' + file_path + '"'
        subprocess.call(command, shell=True)
        name_list = glob.glob(file_path[:-3] + '/**', recursive=True)
        name_list = [name for name in name_list if re.search(r'(\.exe$)|(\.EXE$)', name)]
        for name in name_list:
            str_list = strings.run(name)
            dic = {
                "strings": str_list
            }
            name = name[5:].replace('/', '_')
            if 'Cnet_strings/' + name + '.json' in strings_files:
                path = 'Cnet_strings/' + name + str(count) + '.json'
                count += 1
                icci.append(path + '\n')
            else:
                path = 'Cnet_strings/' + name + '.json'
            with open(path, 'w', encoding='utf-8') as f:
                json.dump(dic, f, indent=4, ensure_ascii=False)
        os.remove(file_path)
        shutil.rmtree(file_path[:-3])
    except:
        import traceback
        traceback.print_exc()
        shutil.move(file_path, 'else/' + file_path[5:])
with open(path4, 'w', encoding='utf-8') as f4:
    f4.writelines(icci)